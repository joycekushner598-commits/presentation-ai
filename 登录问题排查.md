# Google 登录问题排查与解决方案

## 🔍 当前错误

根据日志，出现了两个主要错误：

1. **MissingCSRF 错误**
```
[auth][error] MissingCSRF: CSRF token was missing during an action signin
```

2. **Fetch 失败错误**
```
[auth][error] TypeError: fetch failed
```

---

## ✅ 解决方案

### 方案 1: 检查 Google OAuth 回调 URL（最重要）

1. 访问 Google Cloud Console: https://console.cloud.google.com/apis/credentials

2. 找到你创建的 OAuth 2.0 客户端 ID

3. 检查 **"已获授权的重定向 URI"** 是否包含以下 URL：
   ```
   http://localhost:6100/api/auth/callback/google
   ```
   
4. 如果没有或不正确，点击编辑，添加/修改为：
   - ✅ `http://localhost:6100/api/auth/callback/google`
   
5. 点击 **"保存"**

6. 等待 1-2 分钟让 Google 更新配置

---

### 方案 2: 清除浏览器缓存和 Cookie

1. 打开浏览器开发者工具（F12）
2. 进入 **Application** 或 **存储** 标签
3. 清除以下内容：
   - Cookies (特别是 localhost:6100 的所有 cookies)
   - Local Storage
   - Session Storage
4. 关闭所有 localhost:6100 的标签页
5. 重新打开 http://localhost:6100

---

### 方案 3: 重启应用

有时候配置更改后需要重启应用：

1. 在终端按 `Ctrl+C` 停止应用
2. 重新运行：
   ```powershell
   $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User"); $env:PORT=6100; npm run dev
   ```

---

### 方案 4: 使用无痕/隐私模式

1. 打开浏览器的无痕/隐私模式
2. 访问 http://localhost:6100
3. 尝试登录

这可以排除浏览器缓存/扩展插件的干扰。

---

### 方案 5: 检查 Google OAuth 同意屏幕

1. 访问 https://console.cloud.google.com/apis/credentials/consent
2. 确保状态为 **"测试"** 或 **"已发布"**
3. 确保你的 Google 账号在 **"测试用户"** 列表中

---

### 方案 6: 验证 .env 配置

确保 `.env` 文件配置正确（已检查 ✅）：
```
NEXTAUTH_URL=http://localhost:6100
GOOGLE_CLIENT_ID=1000273014706-i7t27hucnc96flnor1850pgo8map4d3m.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
```

---

## 🔧 快速修复步骤（按顺序尝试）

### 第一步：验证 Google OAuth 配置

在 Google Cloud Console 中，确认重定向 URI：
```
http://localhost:6100/api/auth/callback/google
```

### 第二步：清除浏览器

1. 按 `Ctrl+Shift+Delete` 清除浏览器数据
2. 或使用无痕模式

### 第三步：重启应用

```powershell
# 停止当前应用（Ctrl+C），然后运行：
$env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User"); $env:PORT=6100; npm run dev
```

### 第四步：测试登录

1. 访问 http://localhost:6100
2. 点击 "Sign in with Google"
3. 选择你的 Google 账号
4. 应该会成功登录并重定向

---

## 📝 常见问题

### Q: 为什么会出现 CSRF 错误？
**A:** CSRF（跨站请求伪造）保护是安全机制。错误通常是因为：
- Cookie 没有正确设置
- 浏览器阻止了第三方 Cookie
- 回调 URL 配置错误

### Q: "fetch failed" 是什么意思？
**A:** NextAuth 尝试连接 Google OAuth 服务失败，通常是因为：
- 回调 URL 配置不匹配
- Google OAuth 配置有误
- 网络连接问题

### Q: 需要等多久才能生效？
**A:** Google OAuth 配置更改通常在 1-2 分钟内生效，有时可能需要 5-10 分钟。

---

## 🎯 验证 Google OAuth 配置清单

在 Google Cloud Console 中，你的配置应该是：

**OAuth 2.0 客户端 ID**:
- ✅ 应用类型：Web 应用
- ✅ 名称：任意（例如：Presentation AI）
- ✅ 已获授权的 JavaScript 来源：
  - `http://localhost:6100`
- ✅ 已获授权的重定向 URI：
  - `http://localhost:6100/api/auth/callback/google` ⚠️（最重要）

**OAuth 同意屏幕**:
- ✅ 用户类型：外部
- ✅ 状态：测试中
- ✅ 测试用户：包含你的 Google 账号

---

## 🆘 如果还是不行

1. 尝试创建一个新的 OAuth 2.0 客户端 ID
2. 确保重定向 URI 完全正确（包括协议、端口、路径）
3. 检查防火墙/杀毒软件是否阻止了连接
4. 尝试使用不同的浏览器

---

## 💡 临时测试方案

如果你只是想测试应用功能（不是必须使用 Google 登录），可以：

1. 修改应用代码跳过认证（开发模式）
2. 或使用其他认证方式

但建议还是先解决 Google OAuth 配置问题，这样可以体验完整功能。

---

**最可能的问题：Google OAuth 回调 URL 配置不正确**

请务必检查 Google Cloud Console 中的重定向 URI 是否完全匹配：
```
http://localhost:6100/api/auth/callback/google
```

注意：
- ❌ 不是 `http://localhost:6100/`
- ❌ 不是 `http://localhost:6100/api/auth/callback`
- ❌ 不是 `https://localhost:6100/api/auth/callback/google`
- ✅ 必须是 `http://localhost:6100/api/auth/callback/google`
